name: Extract and Merge ProjectGPT Archive

on:
  # Manual trigger with configurable ZIP path
  workflow_dispatch:
    inputs:
      zip_path:
        description: 'Path to ZIP file (relative to repository root)'
        required: false
        default: 'ProjectGPT.zip'
        type: string

  # Automatic trigger on push events affecting ZIP files
  push:
    paths:
      - '*.zip'

permissions:
  contents: write

jobs:
  extract-and-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set ZIP path
        id: set-zip-path
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ZIP_PATH="${{ github.event.inputs.zip_path }}"
          else
            ZIP_PATH="ProjectGPT.zip"
          fi
          echo "zip_path=${ZIP_PATH}" >> $GITHUB_OUTPUT
          echo "Using ZIP path: ${ZIP_PATH}"

      - name: Validate ZIP file exists
        id: validate
        run: |
          ZIP_PATH="${{ steps.set-zip-path.outputs.zip_path }}"
          if [ ! -f "${ZIP_PATH}" ]; then
            echo "âŒ Error: ZIP file not found at ${ZIP_PATH}"
            exit 1
          fi
          echo "âœ… ZIP file found: ${ZIP_PATH}"
          echo "zip_exists=true" >> $GITHUB_OUTPUT

      - name: Extract ZIP to temporary directory
        if: steps.validate.outputs.zip_exists == 'true'
        id: extract
        run: |
          ZIP_PATH="${{ steps.set-zip-path.outputs.zip_path }}"

          # Create temporary directory for extraction
          TEMP_DIR=$(mktemp -d)
          echo "temp_dir=${TEMP_DIR}" >> $GITHUB_OUTPUT

          # Extract ZIP quietly
          echo "ðŸ“¦ Extracting ${ZIP_PATH} to temporary directory..."
          unzip -q "${ZIP_PATH}" -d "${TEMP_DIR}"

          echo "âœ… Extraction complete"
          echo "Contents of temporary directory:"
          ls -la "${TEMP_DIR}"

      - name: Merge extracted files into repository
        if: steps.validate.outputs.zip_exists == 'true'
        run: |
          TEMP_DIR="${{ steps.extract.outputs.temp_dir }}"

          echo "ðŸ”„ Merging files into repository root..."

          # Copy all files recursively, overwriting existing files
          cp -rf "${TEMP_DIR}"/* . 2>/dev/null || true
          cp -rf "${TEMP_DIR}"/.[!.]* . 2>/dev/null || true

          echo "âœ… Files merged successfully"

      - name: Clean up temporary directory
        if: always() && steps.extract.outputs.temp_dir != ''
        run: |
          TEMP_DIR="${{ steps.extract.outputs.temp_dir }}"
          if [ -d "${TEMP_DIR}" ]; then
            rm -rf "${TEMP_DIR}"
            echo "ðŸ§¹ Cleaned up temporary directory"
          fi

      - name: Remove source ZIP file
        if: steps.validate.outputs.zip_exists == 'true'
        run: |
          ZIP_PATH="${{ steps.set-zip-path.outputs.zip_path }}"
          if [ -f "${ZIP_PATH}" ]; then
            rm -f "${ZIP_PATH}"
            echo "ðŸ—‘ï¸ Removed source ZIP: ${ZIP_PATH}"
          fi

      - name: Configure Git
        if: steps.validate.outputs.zip_exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Stage all changes
        if: steps.validate.outputs.zip_exists == 'true'
        id: stage
        run: |
          # Stage all changes including deletions
          git add -A

          # Check if there are any staged changes
          if git diff --cached --quiet; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes staged for commit"
          fi

      - name: Track change statistics
        if: steps.validate.outputs.zip_exists == 'true' && steps.stage.outputs.no_changes == 'false'
        id: stats
        run: |
          # Count added files (including modified files that show as added in --cached)
          ADDED=$(git diff --cached --name-status | grep -E '^A' | wc -l)

          # Count modified files
          MODIFIED=$(git diff --cached --name-status | grep -E '^M' | wc -l)

          # Count deleted files
          DELETED=$(git diff --cached --name-status | grep -E '^D' | wc -l)

          echo "files_added=${ADDED}" >> $GITHUB_OUTPUT
          echo "files_modified=${MODIFIED}" >> $GITHUB_OUTPUT
          echo "files_deleted=${DELETED}" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Change Statistics:"
          echo "  - Added: ${ADDED} files"
          echo "  - Modified: ${MODIFIED} files"
          echo "  - Deleted: ${DELETED} files"

      - name: Commit changes
        if: steps.validate.outputs.zip_exists == 'true' && steps.stage.outputs.no_changes == 'false'
        run: |
          ADDED="${{ steps.stats.outputs.files_added }}"
          MODIFIED="${{ steps.stats.outputs.files_modified }}"
          DELETED="${{ steps.stats.outputs.files_deleted }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S')

          # Create detailed commit message
          cat << EOF | git commit -F -
          feat: Extract and merge ProjectGPT archive

          Changes:
          - Extracted complete folder structure from ProjectGPT.zip
          - Replaced ${MODIFIED} existing files with updated versions
          - Added ${ADDED} new files
          - Removed source ZIP after successful extraction

          Triggered by: ${ACTOR}
          Timestamp: ${TIMESTAMP} UTC
          Via: GitHub Actions (Copilot Chat)
          EOF

          echo "âœ… Changes committed"

      - name: Push changes
        if: steps.validate.outputs.zip_exists == 'true' && steps.stage.outputs.no_changes == 'false'
        run: |
          git push
          echo "âœ… Changes pushed to repository"

      - name: Generate summary report
        if: always() && steps.validate.outputs.zip_exists == 'true'
        run: |
          if [ "${{ steps.stage.outputs.no_changes }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“¦ ProjectGPT Archive Extraction

          â„¹ï¸  **Status:** No changes detected

          The ZIP file was extracted but no changes were found compared to the current repository state.
          EOF
          else
            ADDED="${{ steps.stats.outputs.files_added }}"
            MODIFIED="${{ steps.stats.outputs.files_modified }}"
            DELETED="${{ steps.stats.outputs.files_deleted }}"

            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“¦ ProjectGPT Archive Extraction

          âœ… **Status:** Successfully extracted and merged

          ### ðŸ“Š Change Statistics
          - **Added:** ${ADDED} files
          - **Modified:** ${MODIFIED} files
          - **Deleted:** ${DELETED} files (including source ZIP)
          EOF
          fi
